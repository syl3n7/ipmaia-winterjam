<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPMAIA WinterJam - Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        /* Add Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #667eea; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #5a6fd8; }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8faff 100%);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1), 0 8px 32px rgba(102, 126, 234, 0.1);
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { background-position: 200% 0; }
            50% { background-position: -200% 0; }
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #6c757d;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .nav-btn {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border: 2px solid rgba(102, 126, 234, 0.2);
            padding: 14px 28px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .nav-btn:hover::before {
            left: 100%;
        }
        
        .nav-btn:hover, .nav-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            border-color: transparent;
        }
        
        .nav-btn:active {
            transform: translateY(-1px) scale(0.98);
        }
        .card {
            background: linear-gradient(135deg, #ffffff 0%, #f8faff 100%);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.08), 0 8px 32px rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            display: none;
            animation: fadeInUp 0.6s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .card.active { 
            display: block; 
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .card h2 {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.8rem;
            font-weight: 700;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 16px;
            border: 2px solid #e8ecf4;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(5px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-1px);
        }
        
        .form-group input:hover, .form-group textarea:hover, .form-group select:hover {
            border-color: #d1d9e6;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 5px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0) scale(0.98);
        }
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2);
        }
        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
        }
        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            background: white;
        }
        .data-table th, .data-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #f1f3f6;
        }
        .data-table th {
            background: linear-gradient(135deg, #f8faff, #f1f5f9);
            font-weight: 600;
            color: #667eea;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .data-table tr {
            transition: all 0.2s ease;
        }
        .data-table tr:hover {
            background: linear-gradient(135deg, #f8faff, #f9fbff);
            transform: scale(1.001);
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .status { 
            padding: 16px 20px; 
            border-radius: 12px; 
            margin: 20px 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .success { 
            background: linear-gradient(135deg, rgba(212, 237, 218, 0.9), rgba(195, 230, 203, 0.9)); 
            color: #155724;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1);
        }
        .success::before { content: '‚úÖ'; }
        
        .error { 
            background: linear-gradient(135deg, rgba(248, 215, 218, 0.9), rgba(245, 198, 203, 0.9)); 
            color: #721c24;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.1);
        }
        .error::before { content: '‚ùå'; }
        
        .info { 
            background: linear-gradient(135deg, rgba(209, 236, 241, 0.9), rgba(190, 229, 235, 0.9)); 
            color: #0c5460;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }
        .info::before { content: '‚ÑπÔ∏è'; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .loading {
            text-align: center;
            padding: 60px;
            color: #667eea;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .loading::before {
            content: '';
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e3e3e3;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
        }
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .badge-success { 
            background: linear-gradient(135deg, #28a745, #20c997); 
            color: white; 
        }
        .badge-secondary { 
            background: linear-gradient(135deg, #6c757d, #5a6268); 
            color: white; 
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 8px;
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header { padding: 25px 20px; }
            .header h1 { font-size: 2rem; }
            .card { padding: 25px 20px; }
            .nav { flex-direction: column; align-items: center; }
            .nav-btn { margin: 5px 0; min-width: 200px; }
            .grid { grid-template-columns: 1fr; }
            .data-table { font-size: 14px; }
            .data-table th, .data-table td { padding: 12px 8px; }
            .action-buttons { flex-direction: column; gap: 8px; }
            .btn-sm { padding: 10px 16px; font-size: 13px; width: 100%; }
        }
        
        /* Enhanced Form Styling */
        .form-section {
            background: rgba(248, 250, 255, 0.5);
            border-radius: 16px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .form-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Authentication Overlay */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .auth-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8faff 100%);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .auth-header h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .auth-header p {
            color: #6c757d;
            margin-bottom: 30px;
        }
        
        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .auth-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .auth-btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .auth-btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        .user-info {
            background: rgba(102, 126, 234, 0.1);
            padding: 10px 16px;
            border-radius: 8px;
            color: #667eea;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Authentication Overlay -->
    <div id="auth-overlay" class="auth-overlay" style="display: none;">
        <div class="auth-card">
            <div class="auth-header">
                <h1>üîê Admin Login</h1>
                <p>Authenticate to access the admin dashboard</p>
            </div>
            
            <div class="auth-buttons">
                <button class="btn auth-btn" onclick="loginWithOIDC()">
                    üîë Login with OIDC
                </button>
            </div>
            
            <div style="margin-top: 20px; text-align: center; opacity: 0.7; font-size: 0.9rem;">
                <p>üîí Secure authentication via OIDC only</p>
                <p>Contact admin if you need access</p>
            </div>
        </div>
    </div>

    <div class="container" id="admin-content">
        <div class="header">
            <h1>üéÆ IPMAIA WinterJam Admin Dashboard</h1>
            <p>Complete Content Management System</p>
            <div id="user-info" class="user-info"></div>
            <div id="status" class="status info" style="margin-top: 15px;">Loading system status...</div>
        </div>

        <!-- Navigation -->
        <div class="nav">
            <button class="nav-btn active" data-section="gamejams">üéÆ Game Jams</button>
            <button class="nav-btn" data-section="games">üéØ Games</button>
            <button class="nav-btn" data-section="users">üë• Users</button>
            <button class="nav-btn" data-section="system">‚öôÔ∏è System</button>
        </div>

        <!-- Game Jams Section -->
        <div id="gamejams-section" class="card active">
            <h2>üéÆ Game Jams Management</h2>
            
            <button class="btn btn-success" id="add-gamejam-btn">+ Add New Game Jam</button>
            
            <div id="gamejam-form" class="form-section" style="display: none;">
                <h3>üìù Add/Edit Game Jam</h3>
                <form id="gamejam-form-element">
                    <div class="grid">
                        <div class="form-group">
                            <label for="jam-name">Name *</label>
                            <input type="text" id="jam-name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="jam-theme">Theme *</label>
                            <input type="text" id="jam-theme" name="theme" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="jam-description">Description</label>
                        <textarea id="jam-description" name="description" placeholder="Describe the game jam..."></textarea>
                    </div>
                    
                    <div class="grid">
                        <div class="form-group">
                            <label for="jam-start">Start Date & Time *</label>
                            <input type="datetime-local" id="jam-start" name="start_date" required>
                        </div>
                        <div class="form-group">
                            <label for="jam-end">End Date & Time *</label>
                            <input type="datetime-local" id="jam-end" name="end_date" required>
                        </div>
                    </div>
                    
                    <div class="grid">
                        <div class="form-group">
                            <label for="jam-reg-start">Registration Start</label>
                            <input type="datetime-local" id="jam-reg-start" name="registration_start_date">
                        </div>
                        <div class="form-group">
                            <label for="jam-reg-end">Registration End</label>
                            <input type="datetime-local" id="jam-reg-end" name="registration_end_date">
                        </div>
                    </div>
                    
                    <div class="grid">
                        <div class="form-group">
                            <label for="jam-reg-url">Registration URL</label>
                            <input type="url" id="jam-reg-url" name="registration_url" placeholder="https://forms.microsoft.com/...">
                        </div>
                        <div class="form-group">
                            <label for="jam-rules-pdf">Rules PDF URL</label>
                            <input type="url" id="jam-rules-pdf" name="rules_pdf_url" placeholder="https://example.com/rules.pdf">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="jam-banner">Banner Image URL</label>
                        <input type="url" id="jam-banner" name="banner_image_url" placeholder="https://example.com/banner.jpg">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="jam-active" name="is_active" checked>
                            Active Game Jam
                        </label>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button type="submit" class="btn btn-success">üíæ Save Game Jam</button>
                        <button type="button" class="btn" id="cancel-gamejam-btn">‚ùå Cancel</button>
                    </div>
                </form>
            </div>
            
            <div id="gamejams-list">
                <div class="loading">Loading game jams...</div>
            </div>
        </div>

        <!-- Games Section -->
        <div id="games-section" class="card">
            <h2>üéØ Games Management</h2>
            
            <button class="btn btn-success" id="add-game-btn">+ Add New Game</button>
            
            <div id="game-form" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h3>Add/Edit Game</h3>
                <form id="game-form-element">
                    <div class="grid">
                        <div class="form-group">
                            <label for="game-title">Game Title *</label>
                            <input type="text" id="game-title" name="title" required>
                        </div>
                        <div class="form-group">
                            <label for="game-jam-select">Game Jam *</label>
                            <select id="game-jam-select" name="game_jam_id" required>
                                <option value="">Select a game jam...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="game-description">Description</label>
                        <textarea id="game-description" name="description" placeholder="Describe the game..."></textarea>
                    </div>
                    
                    <div class="grid">
                        <div class="form-group">
                            <label for="game-team-name">Team Name *</label>
                            <input type="text" id="game-team-name" name="team_name" required>
                        </div>
                        <div class="form-group">
                            <label for="game-team-members">Team Members (comma-separated)</label>
                            <input type="text" id="game-team-members" name="team_members" placeholder="Alice Silva, Bob Santos">
                        </div>
                    </div>
                    
                    <div class="grid">
                        <div class="form-group">
                            <label for="game-github">GitHub URL</label>
                            <input type="url" id="game-github" name="github_url" placeholder="https://github.com/...">
                        </div>
                        <div class="form-group">
                            <label for="game-itch">Itch.io URL</label>
                            <input type="url" id="game-itch" name="itch_url" placeholder="https://example.itch.io/game">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="game-tags">Tags (comma-separated)</label>
                        <input type="text" id="game-tags" name="tags" placeholder="adventure, puzzle, 2d">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="game-featured" name="is_featured">
                            Featured Game
                        </label>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button type="submit" class="btn btn-success">üíæ Save Game</button>
                        <button type="button" class="btn" id="cancel-game-btn">‚ùå Cancel</button>
                    </div>
                </form>
            </div>
            
            <div id="games-list">
                <div class="loading">Loading games...</div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users-section" class="card">
            <h2>üë• Users Management</h2>
            <div class="info status">
                User management functionality coming soon...
            </div>
        </div>

        <!-- System Section -->
        <div id="system-section" class="card">
            <h2>‚öôÔ∏è System Information</h2>
            
            <div class="grid">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3>üîß Quick Actions</h3>
                    <button class="btn" onclick="testHealth()">Health Check</button>
                    <button class="btn" onclick="testAPI()">Test API</button>
                    <button class="btn btn-danger" onclick="clearCache()">Clear Cache</button>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3>üìä Statistics</h3>
                    <div id="stats">Loading stats...</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <h3>üîó API Endpoints</h3>
                <ul style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <li><strong>Health:</strong> GET /health</li>
                    <li><strong>Game Jams:</strong> GET /api/public/gamejams</li>
                    <li><strong>Games:</strong> GET /api/public/games/featured</li>
                    <li><strong>Search:</strong> GET /api/public/games/search?q=term</li>
                    <li><strong>Archive:</strong> GET /api/public/archive/2025</li>
                </ul>
            </div>
            
            <div id="system-response" style="margin-top: 20px;">
                <h3>üìù System Response</h3>
                <pre id="response" style="background: #f8f9fa; padding: 15px; border-radius: 10px; min-height: 100px;">System ready...</pre>
            </div>
        </div>
    </div>

    <script>
        let currentEditingGameJam = null;
        let currentEditingGame = null;
        let gameJams = [];
        let currentUser = null;

        // Authentication Functions
        async function checkAuthentication() {
            try {
                const response = await fetch('/api/auth/me', {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    showAdminDashboard();
                    updateUserInfo();
                } else {
                    showAuthOverlay();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                showAuthOverlay();
            }
        }

        function showAuthOverlay() {
            document.getElementById('auth-overlay').style.display = 'flex';
            document.getElementById('admin-content').style.display = 'none';
        }

        function showAdminDashboard() {
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
        }

        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('user-info').innerHTML = `
                    üë§ ${currentUser.username} (${currentUser.role}) 
                    <button onclick="logout()" class="btn btn-sm" style="margin-left: 10px;">Logout</button>
                `;
            }
        }

        function loginWithOIDC() {
            window.location.href = '/api/auth/oidc/login';
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                location.reload();
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // API Helper Functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = { 
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(endpoint, options);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}`);
                }
                
                return result;
            } catch (error) {
                console.error('API call error:', error);
                throw error;
            }
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        // Navigation Functions
        function showSection(sectionName) {
            console.log('Switching to section:', sectionName);
            
            // Hide all sections
            document.querySelectorAll('.card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Remove active class from nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + '-section').classList.add('active');
            event.target.classList.add('active');
            
            // Load data for the section
            switch(sectionName) {
                case 'gamejams':
                    loadGameJams();
                    break;
                case 'games':
                    loadGames();
                    break;
                case 'system':
                    loadSystemInfo();
                    break;
            }
        }

        // Game Jams Functions
        async function loadGameJams() {
            console.log('Loading game jams...');
            const listDiv = document.getElementById('gamejams-list');
            listDiv.innerHTML = '<div class="loading">Loading game jams...</div>';
            
            try {
                gameJams = await apiCall('/api/admin/gamejams');
                console.log('Loaded game jams:', gameJams);
                renderGameJamsList(gameJams);
            } catch (error) {
                console.error('Error loading game jams:', error);
                listDiv.innerHTML = `<div class="error status">Error loading game jams: ${error.message}</div>`;
            }
        }

        function renderGameJamsList(jams) {
            const listDiv = document.getElementById('gamejams-list');
            
            if (jams.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <h3>No game jams found</h3>
                        <p>Click "Add New Game Jam" to create your first game jam.</p>
                    </div>
                `;
                return;
            }
            
            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Theme</th>
                            <th>Dates</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${jams.map(jam => `
                            <tr>
                                <td><strong>${jam.name}</strong></td>
                                <td>${jam.theme}</td>
                                <td>
                                    ${new Date(jam.start_date).toLocaleDateString()} - 
                                    ${new Date(jam.end_date).toLocaleDateString()}
                                </td>
                                <td>
                                    <span class="badge ${jam.is_active ? 'badge-success' : 'badge-secondary'}">
                                        ${jam.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm" data-edit-jam="${jam.id}">‚úèÔ∏è Edit</button>
                                        <button class="btn btn-danger btn-sm" data-delete-jam="${jam.id}">üóëÔ∏è Delete</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            listDiv.innerHTML = table;
        }

        function showGameJamForm(isEditing = false) {
            console.log('Showing game jam form, isEditing:', isEditing);
            document.getElementById('gamejam-form').style.display = 'block';
            
            // Only reset form and currentEditingGameJam when creating new, not when editing
            if (!isEditing) {
                document.getElementById('gamejam-form-element').reset();
                currentEditingGameJam = null;
                console.log('üÜï Creating new game jam, reset currentEditingGameJam to null');
            } else {
                console.log('‚úèÔ∏è Editing existing game jam, keeping currentEditingGameJam:', currentEditingGameJam);
            }
        }

        function hideGameJamForm() {
            document.getElementById('gamejam-form').style.display = 'none';
            currentEditingGameJam = null;
        }

        async function editGameJam(id) {
            try {
                console.log('üîß Editing game jam with ID:', id);
                const jam = await apiCall(`/api/admin/gamejams/${id}`);
                console.log('üìã Loaded game jam data:', jam);
                currentEditingGameJam = id;
                console.log('‚úÖ Set currentEditingGameJam to:', currentEditingGameJam);
                
                // Fill the form
                console.log('üîç Filling form fields with data:', jam);
                
                const nameField = document.getElementById('jam-name');
                console.log('üìù Name field found:', nameField, 'Setting to:', jam.name);
                if (nameField) nameField.value = jam.name;
                
                const themeField = document.getElementById('jam-theme');
                console.log('üé® Theme field found:', themeField, 'Setting to:', jam.theme);
                if (themeField) themeField.value = jam.theme;
                
                const descField = document.getElementById('jam-description');
                console.log('üìÑ Description field found:', descField, 'Setting to:', jam.description || '');
                if (descField) descField.value = jam.description || '';
                
                const startField = document.getElementById('jam-start');
                const startValue = new Date(jam.start_date).toISOString().slice(0, 16);
                console.log('üìÖ Start field found:', startField, 'Setting to:', startValue);
                if (startField) startField.value = startValue;
                
                const endField = document.getElementById('jam-end');
                const endValue = new Date(jam.end_date).toISOString().slice(0, 16);
                console.log('üìÖ End field found:', endField, 'Setting to:', endValue);
                if (endField) endField.value = endValue;
                
                const regStartField = document.getElementById('jam-reg-start');
                const regStartValue = jam.registration_start_date ? new Date(jam.registration_start_date).toISOString().slice(0, 16) : '';
                console.log('üìÖ Reg start field found:', regStartField, 'Setting to:', regStartValue);
                if (regStartField) regStartField.value = regStartValue;
                
                const regEndField = document.getElementById('jam-reg-end');
                const regEndValue = jam.registration_end_date ? new Date(jam.registration_end_date).toISOString().slice(0, 16) : '';
                console.log('üìÖ Reg end field found:', regEndField, 'Setting to:', regEndValue);
                if (regEndField) regEndField.value = regEndValue;
                
                const regUrlField = document.getElementById('jam-reg-url');
                console.log('üîó Reg URL field found:', regUrlField, 'Setting to:', jam.registration_url || '');
                if (regUrlField) regUrlField.value = jam.registration_url || '';
                
                const rulesPdfField = document.getElementById('jam-rules-pdf');
                console.log('üìã Rules PDF field found:', rulesPdfField, 'Setting to:', jam.rules_pdf_url || '');
                if (rulesPdfField) rulesPdfField.value = jam.rules_pdf_url || '';
                
                const bannerField = document.getElementById('jam-banner');
                console.log('üñºÔ∏è Banner field found:', bannerField, 'Setting to:', jam.banner_image_url || '');
                if (bannerField) bannerField.value = jam.banner_image_url || '';
                
                const activeField = document.getElementById('jam-active');
                console.log('‚úÖ Active field found:', activeField, 'Setting to:', jam.is_active);
                if (activeField) activeField.checked = jam.is_active;
                
                console.log('üéØ Showing form first, then populating...');
                showGameJamForm(true); // Pass true to indicate this is an edit operation
                
                // Small delay to ensure form is visible before populating
                setTimeout(() => {
                    console.log('üîÑ Re-populating fields after form is shown...');
                    if (nameField) nameField.value = jam.name;
                    if (themeField) themeField.value = jam.theme;
                    if (descField) descField.value = jam.description || '';
                    if (startField) startField.value = startValue;
                    if (endField) endField.value = endValue;
                    if (regStartField) regStartField.value = regStartValue;
                    if (regEndField) regEndField.value = regEndValue;
                    if (regUrlField) regUrlField.value = jam.registration_url || '';
                    if (rulesPdfField) rulesPdfField.value = jam.rules_pdf_url || '';
                    if (bannerField) bannerField.value = jam.banner_image_url || '';
                    if (activeField) activeField.checked = jam.is_active;
                    console.log('‚úÖ All game jam form fields re-populated after showing form!');
                }, 100);
                
                console.log('‚úÖ Initial form population completed, form shown');
            } catch (error) {
                showStatus(`Error loading game jam: ${error.message}`, 'error');
            }
        }

        async function deleteGameJam(id) {
            if (!confirm('Are you sure you want to delete this game jam? This action cannot be undone.')) {
                return;
            }
            
            try {
                showStatus('üóëÔ∏è Deleting game jam...', 'info');
                await apiCall(`/api/admin/gamejams/${id}`, 'DELETE');
                showStatus('‚úÖ Game jam deleted successfully!', 'success');
                loadGameJams();
            } catch (error) {
                showStatus(`‚ùå Error deleting game jam: ${error.message}`, 'error');
            }
        }

        // Games Functions
        async function loadGames() {
            const listDiv = document.getElementById('games-list');
            listDiv.innerHTML = '<div class="loading">Loading games...</div>';
            
            try {
                const games = await apiCall('/api/admin/games');
                renderGamesList(games);
                
                // Load game jams for the dropdown
                if (gameJams.length === 0) {
                    gameJams = await apiCall('/api/admin/gamejams');
                }
                populateGameJamSelect();
            } catch (error) {
                listDiv.innerHTML = `<div class="error status">Error loading games: ${error.message}</div>`;
            }
        }

        function renderGamesList(games) {
            const listDiv = document.getElementById('games-list');
            
            if (games.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <h3>No games found</h3>
                        <p>Click "Add New Game" to create your first game entry.</p>
                    </div>
                `;
                return;
            }
            
            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Team</th>
                            <th>Game Jam</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${games.map(game => `
                            <tr>
                                <td><strong>${game.title}</strong></td>
                                <td>${game.team_name}</td>
                                <td>${game.game_jam_name || 'N/A'}</td>
                                <td>
                                    <span class="badge ${game.is_featured ? 'badge-success' : 'badge-secondary'}">
                                        ${game.is_featured ? 'Featured' : 'Normal'}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm" data-edit-game="${game.id}">‚úèÔ∏è Edit</button>
                                        <button class="btn btn-danger btn-sm" data-delete-game="${game.id}">üóëÔ∏è Delete</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            listDiv.innerHTML = table;
        }

        function populateGameJamSelect() {
            const select = document.getElementById('game-jam-select');
            select.innerHTML = '<option value="">Select a game jam...</option>';
            
            gameJams.forEach(jam => {
                const option = document.createElement('option');
                option.value = jam.id;
                option.textContent = jam.name;
                select.appendChild(option);
            });
        }

        function showGameForm(isEditing = false) {
            console.log('Showing game form, isEditing:', isEditing);
            document.getElementById('game-form').style.display = 'block';
            
            // Only reset form and currentEditingGame when creating new, not when editing
            if (!isEditing) {
                document.getElementById('game-form-element').reset();
                currentEditingGame = null;
                console.log('üÜï Creating new game, reset currentEditingGame to null');
            } else {
                console.log('‚úèÔ∏è Editing existing game, keeping currentEditingGame:', currentEditingGame);
            }
        }

        function hideGameForm() {
            document.getElementById('game-form').style.display = 'none';
            currentEditingGame = null;
        }

        async function editGame(id) {
            try {
                console.log('üîß Editing game with ID:', id);
                const game = await apiCall(`/api/admin/games/${id}`);
                console.log('üéÆ Loaded game data:', game);
                currentEditingGame = id;
                console.log('‚úÖ Set currentEditingGame to:', currentEditingGame);
                
                console.log('üéØ Showing form first, then populating...');
                showGameForm(true); // Pass true to indicate this is an edit operation
                
                // Small delay to ensure form is visible before populating
                setTimeout(() => {
                    console.log('üîÑ Populating game form fields...');
                    
                    const titleField = document.getElementById('game-title');
                    console.log('üìù Title field found:', titleField, 'Setting to:', game.title);
                    if (titleField) titleField.value = game.title;
                    
                    const jamSelectField = document.getElementById('game-jam-select');
                    console.log('üéÆ Game jam select field found:', jamSelectField, 'Setting to:', game.game_jam_id);
                    if (jamSelectField) jamSelectField.value = game.game_jam_id;
                    
                    const descField = document.getElementById('game-description');
                    console.log('üìÑ Description field found:', descField, 'Setting to:', game.description || '');
                    if (descField) descField.value = game.description || '';
                    
                    const teamNameField = document.getElementById('game-team-name');
                    console.log('üë• Team name field found:', teamNameField, 'Setting to:', game.team_name);
                    if (teamNameField) teamNameField.value = game.team_name;
                    
                    // Handle team_members - could be JSON string or array
                    let teamMembersText = '';
                    if (game.team_members) {
                        if (typeof game.team_members === 'string') {
                            try {
                                const teamMembers = JSON.parse(game.team_members);
                                teamMembersText = teamMembers.map(m => `${m.name} (${m.role})`).join(', ');
                            } catch (e) {
                                teamMembersText = game.team_members;
                            }
                        } else if (Array.isArray(game.team_members)) {
                            teamMembersText = game.team_members.map(m => `${m.name} (${m.role})`).join(', ');
                        }
                    }
                    const teamMembersField = document.getElementById('game-team-members');
                    console.log('üë§ Team members field found:', teamMembersField, 'Setting to:', teamMembersText);
                    if (teamMembersField) teamMembersField.value = teamMembersText;
                    
                    const githubField = document.getElementById('game-github');
                    console.log('üêô GitHub field found:', githubField, 'Setting to:', game.github_url || '');
                    if (githubField) githubField.value = game.github_url || '';
                    
                    const itchField = document.getElementById('game-itch');
                    console.log('üéÆ Itch field found:', itchField, 'Setting to:', game.itch_url || '');
                    if (itchField) itchField.value = game.itch_url || '';
                    
                    // Handle tags - could be JSON string or array
                    let tagsText = '';
                    if (game.tags) {
                        if (typeof game.tags === 'string') {
                            try {
                                const tags = JSON.parse(game.tags);
                                tagsText = Array.isArray(tags) ? tags.join(', ') : tags;
                            } catch (e) {
                                tagsText = game.tags;
                            }
                        } else if (Array.isArray(game.tags)) {
                            tagsText = game.tags.join(', ');
                        }
                    }
                    const tagsField = document.getElementById('game-tags');
                    console.log('üè∑Ô∏è Tags field found:', tagsField, 'Setting to:', tagsText);
                    if (tagsField) tagsField.value = tagsText;
                    
                    const featuredField = document.getElementById('game-featured');
                    console.log('‚≠ê Featured field found:', featuredField, 'Setting to:', game.is_featured);
                    if (featuredField) featuredField.checked = game.is_featured;
                    
                    console.log('‚úÖ All game form fields populated after showing form!');
                }, 100);
                
                console.log('‚úÖ Initial form population completed, form shown');
            } catch (error) {
                showStatus(`Error loading game: ${error.message}`, 'error');
            }
        }

        async function deleteGame(id) {
            if (!confirm('Are you sure you want to delete this game? This action cannot be undone.')) {
                return;
            }
            
            try {
                showStatus('üóëÔ∏è Deleting game...', 'info');
                await apiCall(`/api/admin/games/${id}`, 'DELETE');
                showStatus('‚úÖ Game deleted successfully!', 'success');
                loadGames();
            } catch (error) {
                showStatus(`‚ùå Error deleting game: ${error.message}`, 'error');
            }
        }

        // System Functions
        async function loadSystemInfo() {
            try {
                const stats = await Promise.all([
                    apiCall('/api/public/gamejams'),
                    apiCall('/api/public/games/featured'),
                    apiCall('/health')
                ]);
                
                document.getElementById('stats').innerHTML = `
                    <p><strong>Game Jams:</strong> ${stats[0].length}</p>
                    <p><strong>Games:</strong> ${stats[1].length}</p>
                    <p><strong>System Status:</strong> ${stats[2].status}</p>
                    <p><strong>Last Updated:</strong> ${new Date().toLocaleString()}</p>
                `;
            } catch (error) {
                document.getElementById('stats').innerHTML = `<p class="error">Error loading stats: ${error.message}</p>`;
            }
        }

        async function testHealth() {
            try {
                const result = await apiCall('/health');
                document.getElementById('response').textContent = JSON.stringify(result, null, 2);
                showStatus('‚úÖ Health check successful', 'success');
            } catch (error) {
                document.getElementById('response').textContent = `Error: ${error.message}`;
                showStatus(`‚ùå Health check failed: ${error.message}`, 'error');
            }
        }

        async function testAPI() {
            try {
                const result = await apiCall('/api/public/gamejams');
                document.getElementById('response').textContent = JSON.stringify(result, null, 2);
                showStatus('‚úÖ API test successful', 'success');
            } catch (error) {
                document.getElementById('response').textContent = `Error: ${error.message}`;
                showStatus(`‚ùå API test failed: ${error.message}`, 'error');
            }
        }

        function clearCache() {
            if (confirm('Are you sure you want to clear the cache?')) {
                showStatus('üßπ Cache cleared', 'success');
            }
        }

        // Form Handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Game Jam Form Handler
            document.getElementById('gamejam-form-element').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                
                // Convert team members string to array
                if (data.team_members) {
                    data.team_members = data.team_members.split(',').map(m => m.trim());
                }
                
                // Convert checkbox to boolean
                data.is_active = formData.has('is_active');
                
                try {
                    console.log('üíæ Saving game jam...');
                    console.log('üîç currentEditingGameJam:', currentEditingGameJam);
                    console.log('üìù Form data:', data);
                    
                    showStatus('üíæ Saving game jam...', 'info');
                    
                    const endpoint = currentEditingGameJam ? 
                        `/api/admin/gamejams/${currentEditingGameJam}` : 
                        '/api/admin/gamejams';
                    const method = currentEditingGameJam ? 'PUT' : 'POST';
                    
                    console.log('üåê API call:', method, endpoint);
                    
                    await apiCall(endpoint, method, data);
                    
                    showStatus('‚úÖ Game jam saved successfully!', 'success');
                    hideGameJamForm();
                    loadGameJams();
                } catch (error) {
                    showStatus(`‚ùå Error saving game jam: ${error.message}`, 'error');
                }
            });
            
            // Game Form Handler
            document.getElementById('game-form-element').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                
                // Convert strings to arrays
                if (data.team_members) {
                    data.team_members = data.team_members.split(',').map(m => m.trim());
                }
                if (data.tags) {
                    data.tags = data.tags.split(',').map(t => t.trim());
                }
                
                // Convert checkbox to boolean
                data.is_featured = formData.has('is_featured');
                
                try {
                    showStatus('üíæ Saving game...', 'info');
                    
                    const endpoint = currentEditingGame ? 
                        `/api/admin/games/${currentEditingGame}` : 
                        '/api/admin/games';
                    const method = currentEditingGame ? 'PUT' : 'POST';
                    
                    await apiCall(endpoint, method, data);
                    
                    showStatus('‚úÖ Game saved successfully!', 'success');
                    hideGameForm();
                    loadGames();
                } catch (error) {
                    showStatus(`‚ùå Error saving game: ${error.message}`, 'error');
                }
            });

            // Navigation event listeners
            document.querySelectorAll('[data-section]').forEach(button => {
                button.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });

            // Add/Cancel button event listeners
            document.getElementById('add-gamejam-btn').addEventListener('click', showGameJamForm);
            document.getElementById('cancel-gamejam-btn').addEventListener('click', hideGameJamForm);
            document.getElementById('add-game-btn').addEventListener('click', showGameForm);
            document.getElementById('cancel-game-btn').addEventListener('click', hideGameForm);

            // Delegated event listeners for dynamic buttons (edit/delete)
            document.addEventListener('click', function(e) {
                console.log('üñ±Ô∏è Click detected on:', e.target);
                console.log('üè∑Ô∏è Attributes:', Array.from(e.target.attributes).map(attr => `${attr.name}="${attr.value}"`));
                
                if (e.target.hasAttribute('data-edit-jam')) {
                    const id = e.target.getAttribute('data-edit-jam');
                    console.log('üìù Edit jam button clicked, ID:', id);
                    editGameJam(id);
                } else if (e.target.hasAttribute('data-delete-jam')) {
                    const id = e.target.getAttribute('data-delete-jam');
                    console.log('üóëÔ∏è Delete jam button clicked, ID:', id);
                    deleteGameJam(id);
                } else if (e.target.hasAttribute('data-edit-game')) {
                    const id = e.target.getAttribute('data-edit-game');
                    console.log('üìù Edit game button clicked, ID:', id);
                    editGame(id);
                } else if (e.target.hasAttribute('data-delete-game')) {
                    const id = e.target.getAttribute('data-delete-game');
                    deleteGame(id);
                }
            });
            
            // Initial load
            checkAuthentication();
            showStatus('üöÄ System ready', 'success');
            loadGameJams();
        });
    </script>
</body>
</html>